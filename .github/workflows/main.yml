
name: ğŸš€ Deploy YST-Store

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: pip install requests flask
    
    - name: Install zrok
      run: |
        wget -q https://github.com/openziti/zrok/releases/latest/download/zrok_linux_amd64.tar.gz
        tar -xzf zrok_linux_amd64.tar.gz
        sudo mv zrok /usr/local/bin/
    
    - name: Setup zrok
      run: |
        zrok enable 9PBrLPS6IYm0
        sleep 3
        zrok reserve yst-store 2>/dev/null || true
    
    - name: Start app
      run: |
        python main.py &
        sleep 10
    
    - name: Start tunnel
      run: |
        zrok share reserved http://localhost:5000 yst-store 2>&1 | tee tunnel.log &
        sleep 15
        URL=$(grep -o 'https://[^ ]*\.zrok\.io' tunnel.log | head -1)
        echo "LIVE_URL=$URL" >> $GITHUB_ENV
    
    - name: Show URL
      run: echo "ğŸŒ LIVE: $LIVE_URL"
    
    - name: Keep alive
      run: sleep 300


name: ğŸš€ Deploy YST-Store

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install requests flask
          pip install --upgrade pip

      - name: âš¡ Install zrok
        run: |
          wget -q https://github.com/openziti/zrok/releases/latest/download/zrok_linux_amd64.tar.gz
          tar -xzf zrok_linux_amd64.tar.gz
          chmod +x zrok
          sudo mv zrok /usr/local/bin/

      - name: ğŸ”‘ Setup zrok
        run: |
          zrok enable 9PBrLPS6IYm0
          sleep 5
          zrok reserve yst-store 2>/dev/null || true

      - name: ğŸš€ Start application
        run: |
          python main.py > app.log 2>&1 &
          echo $! > app_pid.txt
          sleep 12
          
          # Test if app is running
          if curl -s -f http://localhost:5000 > /dev/null; then
            echo "âœ… Application started successfully"
          else
            echo "âŒ Application failed to start"
            echo "=== App logs ==="
            cat app.log
            exit 1
          fi

      - name: ğŸŒ Start zrok tunnel
        id: tunnel
        run: |
          # Start tunnel
          zrok share reserved http://localhost:5000 yst-store 2>&1 | tee tunnel.log &
          echo $! > tunnel_pid.txt
          sleep 20
          
          # Get URL
          if grep -q "https://yst-store.shares.zrok.io" tunnel.log; then
            echo "LIVE_URL=https://yst-store.shares.zrok.io" >> $GITHUB_ENV
          else
            URL=$(grep -o 'https://[a-zA-Z0-9.-]*\.pub\.zrok\.io' tunnel.log | head -1)
            if [ -z "$URL" ]; then
              zrok info > info.log 2>&1
              URL=$(grep -o 'https://[a-zA-Z0-9.-]*\.zrok\.io' info.log | head -1)
            fi
            echo "LIVE_URL=$URL" >> $GITHUB_ENV
          fi
          
          echo "URL: $LIVE_URL"

      - name: ğŸ“¢ Display live URL
        run: |
          echo "========================================"
          echo "ğŸ‰ YST-Store is now LIVE!"
          echo "ğŸŒ URL: $LIVE_URL"
          echo "========================================"
          echo ""
          echo "â° Tunnel will stay active for 5 minutes"

      - name: ğŸ“¤ Save URL artifact
        run: |
          echo "$LIVE_URL" > LIVE_URL.txt
          echo "Deployment Time: $(date)" >> LIVE_URL.txt
          echo "Commit: ${{ github.sha }}" >> LIVE_URL.txt

      - name: â¬†ï¸ Upload URL file
        uses: actions/upload-artifact@v4
        with:
          name: live-url
          path: LIVE_URL.txt
          retention-days: 1

      - name: ğŸ•’ Keep alive (5 minutes)
        run: |
          echo "ğŸ• Tunnel active for 5 minutes..."
          for i in {300..1}; do
            if [ $((i % 60)) -eq 0 ]; then
              minutes=$((i / 60))
              echo "â° $minutes minute(s) remaining..."
            fi
            sleep 1
          done

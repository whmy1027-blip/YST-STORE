
name: ğŸš€ Deploy YST-Store

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: ğŸ“¦ Auto-install Python requirements
      run: |
        echo "ğŸ“Š Checking main.py for required packages..."
        
        # Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù† main.py
        if grep -q "import requests" main.py; then
          echo "ğŸ“¦ Installing requests..."
          pip install requests
        fi
        
        if grep -q "import flask" main.py || grep -q "from flask" main.py; then
          echo "ğŸ“¦ Installing flask..."
          pip install flask
        fi
        
        if grep -q "import pandas" main.py; then
          echo "ğŸ“¦ Installing pandas..."
          pip install pandas
        fi
        
        if grep -q "import numpy" main.py; then
          echo "ğŸ“¦ Installing numpy..."
          pip install numpy
        fi
        
        if grep -q "import sqlite3" main.py; then
          echo "âœ… sqlite3 is built-in"
        fi
        
        # ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹
        pip install requests flask
        
        # Ø¥Ù†Ø´Ø§Ø¡ requirements.txt ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        pip freeze > requirements.txt
        echo "âœ… Generated requirements.txt"

    - name: âš¡ Install zrok
      run: |
        # ØªØ­Ù…ÙŠÙ„ zrok Ù…Ù† GitHub
        LATEST_TAG=$(curl -s https://api.github.com/repos/openziti/zrok/releases/latest | grep '"tag_name":' | sed 's/.*"v\(.*\)".*/\1/')
        echo "ğŸ“¦ Downloading zrok v$LATEST_TAG"
        
        wget -q "https://github.com/openziti/zrok/releases/download/v${LATEST_TAG}/zrok_${LATEST_TAG}_linux_amd64.tar.gz"
        tar -xzf "zrok_${LATEST_TAG}_linux_amd64.tar.gz"
        chmod +x zrok
        sudo mv zrok /usr/local/bin/
        
        echo "âœ… zrok installed: $(zrok version)"

    - name: ğŸ”‘ Setup zrok account
      run: |
        echo "ğŸ”‘ Setting up zrok with your token..."
        zrok enable 9PBrLPS6IYm0
        sleep 3

    - name: ğŸ·ï¸ Try to reserve domain
      id: domain-reservation
      continue-on-error: true
      run: |
        echo "ğŸ·ï¸ Reserving domain: yst-store"
        if zrok reserve yst-store; then
          echo "âœ… Domain reserved!"
          echo "RESERVED=true" >> $GITHUB_ENV
        else
          echo "âš ï¸ Using public domain"
          echo "RESERVED=false" >> $GITHUB_ENV
        fi

    - name: ğŸš€ Run main.py with auto-recovery
      run: |
        echo "ğŸš€ Starting your application..."
        
        # Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ main.py
        timeout 30s python main.py > app.log 2>&1 &
        APP_PID=$!
        echo $APP_PID > pid.txt
        
        # Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
        sleep 8
        
        # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹
        if curl -s -f http://localhost:5000 > /dev/null 2>&1; then
          echo "âœ… Application is running!"
          echo "ğŸ“„ Homepage preview:"
          curl -s http://localhost:5000 | grep -o '<title>[^<]*' | sed 's/<title>//' || echo "No title found"
        else
          echo "âš ï¸ Application not responding, checking logs..."
          echo "=== Application Logs ==="
          cat app.log
          
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙŠÙ„Ø©: ØªØ´ØºÙŠÙ„ Ø®Ø§Ø¯Ù… Ø¨Ø³ÙŠØ· Ø¥Ø°Ø§ ÙØ´Ù„ main.py
          echo "ğŸ”„ Starting backup simple server..."
          pkill -f "python main.py" 2>/dev/null || true
          
          # Ø®Ø§Ø¯Ù… Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨Ø³ÙŠØ·
          cat > backup_server.py << 'EOF'
from http.server import HTTPServer, SimpleHTTPRequestHandler
import os
os.chdir('.')
server = HTTPServer(('0.0.0.0', 5000), SimpleHTTPRequestHandler)
print("Backup server running on port 5000")
server.serve_forever()
EOF
          
          python backup_server.py > backup.log 2>&1 &
          echo $! > backup_pid.txt
          sleep 3
          
          if curl -s http://localhost:5000 > /dev/null 2>&1; then
            echo "âœ… Backup server started!"
          else
            echo "âŒ Could not start any server"
            exit 1
          fi
        fi

    - name: ğŸŒ Start zrok tunnel
      id: zrok-tunnel
      run: |
        echo "ğŸŒ Starting zrok tunnel..."
        
        if [ "$RESERVED" = "true" ]; then
          echo "ğŸ”— Using reserved domain: yst-store"
          zrok share reserved http://localhost:5000 yst-store 2>&1 | tee tunnel.log &
        else
          echo "ğŸ”— Using public domain"
          zrok share public http://localhost:5000 2>&1 | tee tunnel.log &
        fi
        
        ZROK_PID=$!
        echo $ZROK_PID > zrok_pid.txt
        
        # Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù†ÙÙ‚
        sleep 20
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø·
        if [ "$RESERVED" = "true" ]; then
          LIVE_URL="https://yst-store.shares.zrok.io"
        else
          LIVE_URL=$(grep -o 'https://[a-zA-Z0-9.-]*\.pub\.zrok\.io' tunnel.log | head -1)
        fi
        
        # Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙŠÙ„Ø©
        if [ -z "$LIVE_URL" ]; then
          sleep 5
          zrok info 2>&1 | grep -o 'https://[^ ]*\.zrok\.io' | head -1 > url.txt
          LIVE_URL=$(cat url.txt 2>/dev/null || echo "")
        fi
        
        if [ -z "$LIVE_URL" ]; then
          echo "âŒ Could not get URL from zrok"
          echo "=== Tunnel Logs ==="
          cat tunnel.log
          exit 1
        fi
        
        echo "âœ… Live URL: $LIVE_URL"
        echo "LIVE_URL=$LIVE_URL" >> $GITHUB_ENV
        
        # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø§Ø¨Ø·
        echo "ğŸ§ª Testing live URL..."
        if curl -s -f "$LIVE_URL" > /dev/null 2>&1; then
          echo "ğŸ‰ URL is accessible!"
        else
          echo "âš ï¸ URL might need more time to propagate"
        fi

    - name: ğŸ“‹ Generate deployment info
      run: |
        echo "## ğŸš€ YST-Store Deployment" > README_DEPLOY.md
        echo "" >> README_DEPLOY.md
        echo "**ğŸŒ Live URL:** [$LIVE_URL]($LIVE_URL)" >> README_DEPLOY.md
        echo "" >> README_DEPLOY.md
        echo "**ğŸ“… Deployed:** $(date)" >> README_DEPLOY.md
        echo "**ğŸ”§ Status:** âœ… Active" >> README_DEPLOY.md
        echo "**ğŸ·ï¸ Domain:** $([ "$RESERVED" = "true" ] && echo 'Reserved (yst-store)' || echo 'Public')" >> README_DEPLOY.md
        echo "" >> README_DEPLOY.md
        echo "### Quick Test" >> README_DEPLOY.md
        echo '```bash' >> README_DEPLOY.md
        echo "curl -s $LIVE_URL" >> README_DEPLOY.md
        echo '```' >> README_DEPLOY.md
        
        # Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ù…Ù„Ù Ù…Ù†ÙØµÙ„
        echo "$LIVE_URL" > LIVE_URL.txt
        echo "$LIVE_URL"

    - name: ğŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: yst-store-live
        path: |
          README_DEPLOY.md
          LIVE_URL.txt
          app.log
          tunnel.log
        retention-days: 1

    - name: ğŸ“¢ Post workflow summary
      run: |
        echo "## ğŸ‰ YST-Store Successfully Deployed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸŒ **Live URL**" >> $GITHUB_STEP_SUMMARY
        echo "[$LIVE_URL]($LIVE_URL)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš¡ **Quick Test**" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "curl -s $LIVE_URL | head -5" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "â° *This tunnel will be active for ~15 minutes*" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ•’ Maintain tunnel
      run: |
        echo "â³ Keeping tunnel active for 10 minutes..."
        echo "ğŸ“¡ Live at: $LIVE_URL"
        
        # Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ
        for i in {600..1}; do
          if [ $((i % 60)) -eq 0 ]; then
            echo "â° $((i/60)) minute(s) remaining..."
          fi
          sleep 1
        done
        echo "â° Time's up! Tunnel will close."

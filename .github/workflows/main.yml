
name: ğŸš€ Deploy YST-Store with Domain Reservation

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: ğŸ“¦ Install dependencies
      run: |
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        else
          pip install flask
          echo "flask" > requirements.txt
        fi

    - name: âš¡ Install zrok (FIXED)
      run: |
        # ØªØ­Ù…ÙŠÙ„ zrok Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† GitHub Releases
        echo "Downloading zrok from GitHub releases..."
        
        # Ø£Ø­Ø¯Ø« Ø¥ØµØ¯Ø§Ø± Ù…Ù† GitHub
        ZROK_VERSION=$(curl -s https://api.github.com/repos/openziti/zrok/releases/latest | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
        echo "Latest zrok version: $ZROK_VERSION"
        
        # ØªØ­Ù…ÙŠÙ„ ÙˆØªØ«Ø¨ÙŠØª
        wget -q "https://github.com/openziti/zrok/releases/download/v${ZROK_VERSION}/zrok_${ZROK_VERSION}_linux_amd64.tar.gz"
        tar -xzf "zrok_${ZROK_VERSION}_linux_amd64.tar.gz"
        
        # Ø¬Ø¹Ù„Ù‡ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ†ÙÙŠØ° ÙˆÙ†Ù‚Ù„Ù‡ Ù„Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­
        chmod +x zrok
        sudo mv zrok /usr/local/bin/
        
        # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ«Ø¨ÙŠØª
        zrok version

    - name: ğŸ”‘ Authenticate zrok
      run: |
        zrok enable 9PBrLPS6IYm0
        sleep 5

    - name: ğŸ·ï¸ Reserve Domain (yst-store)
      id: reserve-domain
      run: |
        echo "ğŸ“ Attempting to reserve domain: yst-store"
        
        # Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø¬Ø² Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†
        if zrok reserve yst-store 2>&1 | tee reserve.log; then
          echo "âœ… Domain 'yst-store' reserved successfully"
          echo "RESERVED=true" >> $GITHUB_ENV
          echo "RESERVED_DOMAIN=yst-store" >> $GITHUB_ENV
        else
          echo "âš ï¸ Domain reservation failed, checking status..."
          
          # ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† Ù…Ø­Ø¬ÙˆØ² Ù…Ø³Ø¨Ù‚Ø§Ù‹
          if grep -q "already exists" reserve.log; then
            echo "â„¹ï¸ Domain already reserved (might be yours)"
            echo "RESERVED=true" >> $GITHUB_ENV
            echo "RESERVED_DOMAIN=yst-store" >> $GITHUB_ENV
          else
            echo "âŒ Cannot reserve domain, will use public domain"
            echo "RESERVED=false" >> $GITHUB_ENV
            echo "RESERVED_DOMAIN=public" >> $GITHUB_ENV
          fi
        fi

    - name: ğŸš€ Start main.py on port 5000
      run: |
        echo "ğŸš€ Starting main.py..."
        
        # Ø¥Ù†Ù‡Ø§Ø¡ Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙˆØ±Øª 5000
        sudo fuser -k 5000/tcp 2>/dev/null || true
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        nohup python main.py > app_output.log 2>&1 &
        echo $! > app_pid.txt
        sleep 5
        
        # Ø§Ù†ØªØ¸Ø§Ø± ÙˆØ§Ø®ØªØ¨Ø§Ø±
        for i in {1..10}; do
          if curl -s -f http://localhost:5000 > /dev/null 2>&1; then
            echo "âœ… Application is running on port 5000"
            echo "=== App output (last 5 lines) ==="
            tail -5 app_output.log
            break
          fi
          echo "â³ Waiting for application... ($i/10)"
          sleep 3
        done
        
        if ! curl -s -f http://localhost:5000 > /dev/null 2>&1; then
          echo "âŒ Application failed to start"
          echo "=== Full app output ==="
          cat app_output.log
          exit 1
        fi

    - name: ğŸŒ Start zrok Tunnel
      id: start-tunnel
      run: |
        echo "ğŸ”— Starting zrok tunnel..."
        
        if [ "$RESERVED" = "true" ]; then
          echo "Using RESERVED domain: yst-store"
          zrok share reserved http://localhost:5000 yst-store > tunnel.log 2>&1 &
        else
          echo "Using PUBLIC domain"
          zrok share public http://localhost:5000 > tunnel.log 2>&1 &
        fi
        
        echo $! > tunnel_pid.txt
        sleep 15
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø·
        if [ "$RESERVED" = "true" ]; then
          FINAL_URL="https://yst-store.shares.zrok.io"
        else
          # Ø§Ù„Ø¨Ø­Ø« ÙÙŠ logs
          FINAL_URL=$(grep -o 'https://[a-zA-Z0-9.-]*\.pub\.zrok\.io' tunnel.log | head -1)
        fi
        
        if [ -z "$FINAL_URL" ]; then
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®Ø±Ù‰
          sleep 5
          zrok info 2>&1 | grep -o 'https://[a-zA-Z0-9.-]*\.zrok\.io' | head -1 > url.txt
          FINAL_URL=$(cat url.txt || echo "")
        fi
        
        if [ -z "$FINAL_URL" ]; then
          echo "âŒ Failed to get zrok URL"
          echo "=== Tunnel log ==="
          cat tunnel.log
          exit 1
        fi
        
        echo "âœ… Tunnel started: $FINAL_URL"
        echo "FINAL_URL=$FINAL_URL" >> $GITHUB_ENV

    - name: ğŸ“‹ Create Report
      run: |
        echo "ğŸš€ **Live URL:** $FINAL_URL" > report.md
        echo "" >> report.md
        echo "**Time:** $(date)" >> report.md
        echo "**Commit:** ${{ github.sha }}" >> report.md
        echo "$FINAL_URL" > live-url.txt

    - name: ğŸ“¤ Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-${{ github.run_id }}
        path: |
          report.md
          live-url.txt
        retention-days: 1

    - name: ğŸ“¢ Post Summary
      run: |
        echo "## âœ… YST-Store Deployed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸŒ Live URL:** [$FINAL_URL]($FINAL_URL)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Test it:** \`curl $FINAL_URL\`" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ•’ Keep Alive
      run: |
        echo "â³ Tunnel active for 5 minutes..."
        sleep 300

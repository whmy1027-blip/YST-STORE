name: ğŸš€ Deploy YST-Store with Domain Reservation

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: ğŸ“¦ Install dependencies
      run: |
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        else
          pip install flask
          echo "flask" > requirements.txt
        fi

    - name: âš¡ Install zrok
      run: |
        curl -sL https://zrok.io/install | sudo bash
        zrok version

    - name: ğŸ”‘ Authenticate zrok
      run: |
        zrok enable 9PBrLPS6IYm0
        sleep 5

    - name: ğŸ·ï¸ Reserve Domain (yst-store)
      id: reserve-domain
      run: |
        echo "ğŸ“ Attempting to reserve domain: yst-store"
        
        # Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø¬Ø² Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†
        if zrok reserve yst-store 2>&1 | tee reserve.log; then
          echo "âœ… Domain 'yst-store' reserved successfully"
          echo "RESERVED=true" >> $GITHUB_ENV
          echo "RESERVED_DOMAIN=yst-store" >> $GITHUB_ENV
        else
          echo "âš ï¸ Domain reservation failed, checking status..."
          
          # ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† Ù…Ø­Ø¬ÙˆØ² Ù…Ø³Ø¨Ù‚Ø§Ù‹
          if grep -q "already exists" reserve.log; then
            echo "â„¹ï¸ Domain already reserved (might be yours)"
            echo "RESERVED=true" >> $GITHUB_ENV
            echo "RESERVED_DOMAIN=yst-store" >> $GITHUB_ENV
          else
            echo "âŒ Cannot reserve domain, will use public domain"
            echo "RESERVED=false" >> $GITHUB_ENV
            echo "RESERVED_DOMAIN=public" >> $GITHUB_ENV
          fi
        fi

    - name: ğŸš€ Start main.py on port 5000
      run: |
        echo "ğŸš€ Starting main.py..."
        
        # Ø¥Ù†Ù‡Ø§Ø¡ Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙˆØ±Øª 5000
        fuser -k 5000/tcp 2>/dev/null || true
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        nohup python main.py > app_output.log 2>&1 &
        echo $! > app_pid.txt
        
        # Ø§Ù†ØªØ¸Ø§Ø± ÙˆØ§Ø®ØªØ¨Ø§Ø±
        for i in {1..15}; do
          if curl -s -f http://localhost:5000 > /dev/null 2>&1; then
            echo "âœ… Application is running on port 5000"
            echo "=== App output (last 5 lines) ==="
            tail -5 app_output.log
            break
          fi
          echo "â³ Waiting for application... ($i/15)"
          sleep 2
          
          if [ $i -eq 15 ]; then
            echo "âŒ Application failed to start"
            echo "=== Full app output ==="
            cat app_output.log
            exit 1
          fi
        done

    - name: ğŸŒ Start zrok Tunnel with Reserved Domain
      id: start-tunnel
      run: |
        echo "ğŸ”— Starting zrok tunnel..."
        
        if [ "$RESERVED" = "true" ]; then
          echo "Using RESERVED domain: yst-store"
          
          # Ø¨Ø¯Ø¡ Ø§Ù„Ù†ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¬ÙˆØ²
          zrok share reserved http://localhost:5000 yst-store > tunnel.log 2>&1 &
          TUNNEL_PID=$!
          echo $TUNNEL_PID > tunnel_pid.txt
          
          # Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„Ø¯ÙˆÙ…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¬ÙˆØ²
          EXPECTED_URL="https://yst-store.shares.zrok.io"
          echo "Expected URL: $EXPECTED_URL"
          
        else
          echo "Using PUBLIC domain"
          
          # Ø¨Ø¯Ø¡ Ø§Ù„Ù†ÙÙ‚ Ø§Ù„Ø¹Ø§Ù…
          zrok share public http://localhost:5000 > tunnel.log 2>&1 &
          TUNNEL_PID=$!
          echo $TUNNEL_PID > tunnel_pid.txt
          
          EXPECTED_URL="public"
        fi
        
        # Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù†ÙÙ‚
        sleep 20
        
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ÙØ¹Ù„ÙŠ
        if [ "$RESERVED" = "true" ]; then
          FINAL_URL="$EXPECTED_URL"
        else
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ø§Ù… Ù…Ù† logs
          FINAL_URL=$(grep -o 'https://[a-zA-Z0-9.-]*\.pub\.zrok\.io' tunnel.log | head -1)
          
          if [ -z "$FINAL_URL" ]; then
            # Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… zrok info
            sleep 5
            zrok info > info.log 2>&1
            FINAL_URL=$(grep -o 'https://[a-zA-Z0-9.-]*\.pub\.zrok\.io' info.log | head -1)
          fi
        fi
        
        if [ -z "$FINAL_URL" ]; then
          echo "âŒ Failed to get zrok URL"
          echo "=== Tunnel log ==="
          cat tunnel.log
          exit 1
        fi
        
        echo "âœ… Tunnel started successfully!"
        echo "ğŸŒ Live URL: $FINAL_URL"
        
        # Ø­ÙØ¸ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        echo "FINAL_URL=$FINAL_URL" >> $GITHUB_ENV
        echo "DEPLOYMENT_TIME=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV

    - name: ğŸ“‹ Create Deployment Report
      run: |
        cat > deployment-report.md << EOF
        # ğŸš€ YST-Store Deployment Report
        
        ## âœ… Deployment Successful
        **Live URL:** [$FINAL_URL]($FINAL_URL)
        **Status:** ğŸŸ¢ Active
        **Deployment Time:** $DEPLOYMENT_TIME
        
        ## ğŸ”§ Configuration
        - **Domain Type:** $([ "$RESERVED" = "true" ] && echo "Reserved Domain (yst-store)" || echo "Public Domain")
        - **Application:** main.py
        - **Port:** 5000
        - **Python Version:** 3.9
        
        ## ğŸ§ª Quick Tests
        \`\`\`bash
        # Test home page
        curl $FINAL_URL
        
        # Health check (if available)
        curl $FINAL_URL/health
        \`\`\`
        
        ## âš ï¸ Important Notes
        1. This tunnel will remain active for **15 minutes maximum**
        2. The URL will stop working once this workflow completes
        3. For permanent hosting, consider GitHub Pages or other services
        
        ## ğŸ“Š Logs
        - Application logs: \`app_output.log\`
        - Tunnel logs: \`tunnel.log\`
        EOF
        
        # Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ù…Ù„Ù Ù†ØµÙŠ
        echo "$FINAL_URL" > live-url.txt
        echo "DOMAIN_TYPE=$([ "$RESERVED" = "true" ] && echo "reserved" || echo "public")" >> deployment-info.txt

    - name: ğŸ“¤ Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: yst-store-deployment-${{ github.run_id }}
        path: |
          deployment-report.md
          live-url.txt
          deployment-info.txt
          app_output.log
          tunnel.log
        retention-days: 7

    - name: ğŸ“¢ Post Summary
      run: |
        echo "## ğŸ‰ YST-Store Deployed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸŒ **Live URL**" >> $GITHUB_STEP_SUMMARY
        echo "[$FINAL_URL]($FINAL_URL)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š **Deployment Details**" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** âœ… Active" >> $GITHUB_STEP_SUMMARY
        echo "- **Domain:** $([ "$RESERVED" = "true" ] && echo '`yst-store.shares.zrok.io` (Reserved)' || echo 'Public Domain')" >> $GITHUB_STEP_SUMMARY
        echo "- **Port:** 5000" >> $GITHUB_STEP_SUMMARY
        echo "- **Main File:** \`main.py\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment Time:** $DEPLOYMENT_TIME" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš¡ **Quick Test**" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "curl -s $FINAL_URL | grep -o '<title>[^<]*' | cut -d'>' -f2" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: ğŸ•’ Keep Alive (10 minutes)
      run: |
        echo "â³ Keeping tunnel active for 10 minutes..."
        echo "ğŸ“¡ URL: $FINAL_URL"
        echo "" 
        echo "You can test the URL now in your browser!"
        echo "This workflow will auto-terminate after timeout."
        
        # Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ
        for i in {1..600}; do
          if [ $((i % 60)) -eq 0 ]; then
            echo "â° Active for $((i/60)) minute(s)..."
          fi
          sleep 1
        done
